name: ğŸš€ Build & Release IN Studio Files

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: ğŸ”¨ Build Application
    runs-on: windows-latest
    
    strategy:
      matrix:
        configuration: [Debug, Release]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ”§ Setup .NET 6.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'

    - name: ğŸ”¨ Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore AutoCopy.sln

    - name: ğŸ—ï¸ Build solution
      run: dotnet build AutoCopy.sln --configuration ${{ matrix.configuration }} --no-restore

    - name: ğŸ“Š Display build info
      run: |
        echo "âœ… Build completed successfully!"
        echo "Configuration: ${{ matrix.configuration }}"
        echo "Project: IN Studio Files v1.1"

    - name: ğŸ“¤ Upload build artifacts (Release only)
      if: matrix.configuration == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: INStudioFiles-${{ matrix.configuration }}
        path: |
          bin/Release/net6.0-windows/
          !bin/Release/net6.0-windows/*.pdb
        retention-days: 30

  publish:
    name: ğŸ“¦ Publish Self-Contained
    runs-on: windows-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET 6.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'

    - name: ğŸ“¦ Publish Windows x64 (Self-Contained)
      run: |
        dotnet publish AutoCopy.csproj `
          -c Release `
          -r win-x64 `
          --self-contained `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:EnableCompressionInSingleFile=true `
          -p:DebugType=None `
          -p:DebugSymbols=false

    - name: ğŸ“Š Display publish info
      run: |
        echo "âœ… Publish completed!"
        $size = (Get-Item "bin/Release/net6.0-windows/win-x64/publish/INStudioFiles.exe").Length / 1MB
        echo "ğŸ“¦ Executable size: $([math]::Round($size, 2)) MB"

    - name: ğŸ“¤ Upload published executable
      uses: actions/upload-artifact@v4
      with:
        name: INStudioFiles-Standalone-x64
        path: bin/Release/net6.0-windows/win-x64/publish/
        retention-days: 90

  release:
    name: ğŸ‰ Create GitHub Release
    runs-on: windows-latest
    needs: publish
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET 6.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'

    - name: ğŸ“¦ Publish Release Build
      run: |
        dotnet publish AutoCopy.csproj `
          -c Release `
          -r win-x64 `
          --self-contained `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:EnableCompressionInSingleFile=true `
          -p:DebugType=None `
          -p:DebugSymbols=false

    - name: ğŸ“¦ Create ZIP archive
      run: |
        $publishPath = "bin/Release/net6.0-windows/win-x64/publish"
        $version = "${{ github.ref_name }}"
        Compress-Archive -Path "$publishPath/*" -DestinationPath "INStudioFiles-$version-win-x64.zip"
        echo "âœ… ZIP created: INStudioFiles-$version-win-x64.zip"

    - name: ğŸ“Š Generate Release Notes
      id: release_notes
      run: |
        $notes = @"
        # ğŸ¨ IN Studio Files ${{ github.ref_name }}
        
        ## âœ¨ What's New
        - Modern animated UI with 132 animations
        - Dark/Light theme system (66 colors each)
        - Multi-threaded file copy (1-10 threads)
        - Compact progress dashboard
        - File verification system
        - Resume capability
        - 40+ RAW format support
        
        ## ğŸ”§ Improvements
        - Memory leak fixed (proper resource disposal)
        - Smooth scrolling everywhere
        - Equal-sized buttons
        - Professional UI polish
        
        ## ğŸ“¦ Installation
        1. Download ``INStudioFiles-${{ github.ref_name }}-win-x64.zip``
        2. Extract to any folder
        3. Run ``INStudioFiles.exe``
        4. No .NET installation required (self-contained)
        
        ## ğŸ’» System Requirements
        - Windows 10/11 (x64)
        - 100 MB disk space
        
        ## ğŸ› Bug Reports
        Please report issues on GitHub Issues page.
        "@
        
        $notes | Out-File -FilePath release_notes.md -Encoding utf8
        echo "âœ… Release notes generated"

    - name: ğŸ‰ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          INStudioFiles-${{ github.ref_name }}-win-x64.zip
          release_notes.md
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  code-quality:
    name: ğŸ” Code Quality Check
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET 6.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'

    - name: ğŸ“Š Code Metrics
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š CODE METRICS"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        $xamlLines = (Get-Content MainWindow.xaml).Count
        $csLines = (Get-Content MainWindow.xaml.cs).Count
        $totalFiles = (Get-ChildItem -Recurse -Include *.cs,*.xaml | Where-Object { $_.FullName -notmatch "\\obj\\|\\bin\\" }).Count
        
        echo "ğŸ“„ XAML: $xamlLines lines"
        echo "ğŸ’» C#: $csLines lines"  
        echo "ğŸ“ Total files: $totalFiles"
        echo ""
        echo "âœ… Code metrics collected!"

    - name: ğŸ” Check for common issues
      run: |
        echo "ğŸ” Checking for potential issues..."
        
        # Check for TODO comments
        $todos = Select-String -Path "*.cs" -Pattern "TODO|FIXME|HACK" -ErrorAction SilentlyContinue
        if ($todos) {
          echo "âš ï¸ Found TODO/FIXME comments:"
          $todos | Select-Object -First 5
        } else {
          echo "âœ… No TODO/FIXME comments found"
        }
        
        echo ""
        echo "âœ… Quality check complete!"
